<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cata Colaborativa de Ron</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <h2>Cargando Cata...</h2>
            <div class="spinner"></div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <h2>Cata Colaborativa de Ron</h2>
        
        <!-- Datos ocultos para JavaScript -->
        <script type="application/json" id="rones-data">{{ rones | tojson }}</script>
        <script type="application/json" id="puntajes-data">{{ puntajes | tojson }}</script>
        <script type="application/json" id="user-data">{{ {"user_id": user_id, "is_master": is_master} | tojson }}</script>
        <script type="application/json" id="initial-data">{{ {"current_step": current_step, "users": users_data} | tojson }}</script>
        
        <!-- Panel de control del master -->
        <div id="master-controls" style="display: none;">
            <div class="control-panel">
                <h3>üéõÔ∏è Control de Cata</h3>
                <div class="nav-buttons">
                    <button id="prev-btn" onclick="prevStep()">‚¨ÖÔ∏è Anterior</button>
                    <button id="next-btn" onclick="nextStep()">Siguiente ‚û°Ô∏è</button>
                    <button id="reset-btn" onclick="resetSession()" class="reset-btn">üîÑ Reiniciar</button>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n del paso actual -->
        <div id="step-info" class="step-info">
            <div id="step-title"></div>
            <div id="step-description"></div>
        </div>

        <!-- Panel de participantes -->
        <div id="participants-panel" class="participants-panel">
            <h3>üë• Participantes (<span id="participant-count">0</span>)</h3>
            <div id="participants-list"></div>
        </div>

        <!-- Contenido principal por pasos -->
        <div id="step-content">
            
            <!-- Paso 0: Bienvenida -->
            <div id="step-0" class="step-content" style="display: none;">
                <div class="welcome-panel">
                    <h3>¬°Bienvenido a la Cata de Ron!</h3>
                    <p>Por favor ingresa tu nombre para comenzar:</p>
                    <input type="text" id="user-name" placeholder="Tu nombre" maxlength="20">
                    <button onclick="setUserName()">Comenzar</button>
                </div>
            </div>

            <!-- Pasos 1-4: Evaluaci√≥n de rones -->
            <div id="step-evaluation" class="step-content" style="display: none;">
                <form id="evaluation-form">
                    <div class="criteria-grid">
                        <div class="criteria-row">
                            <label>Pureza (Cristalina, transparente, sin part√≠culas en suspensi√≥n)</label>
                            <div class="radio-group" data-criteria="pureza"></div>
                        </div>
                        
                        <div class="criteria-row">
                            <label>Olfato - Intensidad (Intensidad de aromas percibidos)</label>
                            <div class="radio-group" data-criteria="olfato_intensidad"></div>
                        </div>
                        
                        <div class="criteria-row">
                            <label>Olfato - Complejidad (Variedad y complejidad de aromas)</label>
                            <div class="radio-group" data-criteria="olfato_complejidad"></div>
                        </div>
                        
                        <div class="criteria-row">
                            <label>Gusto - Intensidad (Intensidad de sabores en boca)</label>
                            <div class="radio-group" data-criteria="gusto_intensidad"></div>
                        </div>
                        
                        <div class="criteria-row">
                            <label>Gusto - Complejidad (Variedad y complejidad de sabores)</label>
                            <div class="radio-group" data-criteria="gusto_complejidad"></div>
                        </div>
                        
                        <div class="criteria-row">
                            <label>Gusto - Persistencia (Duraci√≥n del sabor despu√©s de tragar)</label>
                            <div class="radio-group" data-criteria="gusto_persistencia"></div>
                        </div>
                        
                        <div class="criteria-row">
                            <label>Armon√≠a (Equilibrio general entre todos los aspectos)</label>
                            <div class="radio-group" data-criteria="armonia"></div>
                        </div>
                    </div>
                    
                    <div class="notes-section">
                        <label for="notes">Notas adicionales:</label>
                        <textarea id="notes" placeholder="Describe tus impresiones del ron..."></textarea>
                    </div>
                    
                    <div class="total-score">
                        <h3>Puntuaci√≥n Total: <span id="total-score">0</span></h3>
                    </div>
                    
                    <button type="button" onclick="submitEvaluation()">Enviar Evaluaci√≥n</button>
                </form>
            </div>

            <!-- Paso 5: Resumen final -->
            <div id="step-5" class="step-content" style="display: none;">
                <div class="final-summary">
                    <h3>üèÜ Resumen Final de la Cata</h3>
                    <div id="final-rankings"></div>
                </div>
            </div>
        </div>

        <!-- Panel de resultados en tiempo real -->
        <div id="results-panel" class="results-panel">
            <h3>üìä Resultados en Tiempo Real</h3>
            <div id="current-results"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUserId = null;
        let isMaster = false;
        let currentStep = 0;
        let usersData = {};
        let currentRon = '';

        const RONES = JSON.parse(document.getElementById('rones-data').textContent);
        const PUNTAJES = JSON.parse(document.getElementById('puntajes-data').textContent);
        const USER_DATA = JSON.parse(document.getElementById('user-data').textContent);
        const INITIAL_DATA = JSON.parse(document.getElementById('initial-data').textContent);

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            currentUserId = USER_DATA.user_id;
            isMaster = USER_DATA.is_master;
            currentStep = INITIAL_DATA.current_step;
            usersData = INITIAL_DATA.users;

            initializeApp();
            
            // Polling para actualizaciones cada 2 segundos
            setInterval(fetchUpdates, 2000);
        });

        function initializeApp() {
            setupRadioGroups();
            updateStepDisplay();
            updateParticipants();
            updateResults();
            
            if (isMaster) {
                document.getElementById('master-controls').style.display = 'block';
            }
            
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }

        function setupRadioGroups() {
            Object.entries(PUNTAJES).forEach(([criteria, values]) => {
                const container = document.querySelector(`[data-criteria="${criteria}"]`);
                container.innerHTML = '';
                
                values.forEach((value, index) => {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = criteria;
                    radio.value = value;
                    radio.id = `${criteria}_${index}`;
                    radio.addEventListener('change', updateTotalScore);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `${criteria}_${index}`;
                    label.textContent = value;
                    
                    container.appendChild(radio);
                    container.appendChild(label);
                });
            });
        }

        function updateTotalScore() {
            let total = 0;
            Object.keys(PUNTAJES).forEach(criteria => {
                const selected = document.querySelector(`input[name="${criteria}"]:checked`);
                if (selected) {
                    total += parseInt(selected.value);
                }
            });
            document.getElementById('total-score').textContent = total;
        }

        async function fetchUpdates() {
            try {
                const response = await fetch('/api/get_data');
                const data = await response.json();
                
                if (data.current_step !== currentStep) {
                    currentStep = data.current_step;
                    updateStepDisplay();
                }
                
                usersData = data.users;
                updateParticipants();
                updateResults();
            } catch (error) {
                console.error('Error fetching updates:', error);
            }
        }

        async function setUserName() {
            const name = document.getElementById('user-name').value.trim();
            if (!name) {
                alert('Por favor ingresa tu nombre');
                return;
            }

            try {
                const response = await fetch('/api/set_name', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nombre: name })
                });

                if (response.ok) {
                    await fetchUpdates();
                } else {
                    alert('Error al establecer el nombre');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function submitEvaluation() {
            const evaluation = {};
            let allSelected = true;

            Object.keys(PUNTAJES).forEach(criteria => {
                const selected = document.querySelector(`input[name="${criteria}"]:checked`);
                if (selected) {
                    evaluation[criteria] = parseInt(selected.value);
                } else {
                    allSelected = false;
                }
            });

            if (!allSelected) {
                alert('Por favor completa todos los criterios');
                return;
            }

            const notes = document.getElementById('notes').value;

            try {
                const response = await fetch('/api/submit_evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ron: currentRon,
                        evaluacion: evaluation,
                        notas: notes
                    })
                });

                if (response.ok) {
                    alert('Evaluaci√≥n enviada correctamente');
                    await fetchUpdates();
                } else {
                    alert('Error al enviar evaluaci√≥n');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function nextStep() {
            if (!isMaster) return;

            try {
                const response = await fetch('/api/next_step', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    await fetchUpdates();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function prevStep() {
            if (!isMaster) return;

            try {
                const response = await fetch('/api/prev_step', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    await fetchUpdates();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function resetSession() {
            if (!isMaster) return;
            
            if (confirm('¬øEst√°s seguro de que quieres reiniciar la sesi√≥n? Se perder√°n todos los datos.')) {
                try {
                    const response = await fetch('/api/reset_session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({})
                    });

                    if (response.ok) {
                        location.reload();
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }

        function updateStepDisplay() {
            // Ocultar todos los contenidos de paso
            document.querySelectorAll('.step-content').forEach(el => {
                el.style.display = 'none';
            });

            let stepTitle = '';
            let stepDescription = '';

            if (currentStep === 0) {
                document.getElementById('step-0').style.display = 'block';
                stepTitle = 'üéØ Bienvenida';
                stepDescription = 'Ingresa tu nombre para comenzar la cata';
            } else if (currentStep >= 1 && currentStep <= 4) {
                document.getElementById('step-evaluation').style.display = 'block';
                currentRon = RONES[currentStep - 1];
                stepTitle = `ü•É Ron ${currentRon}`;
                stepDescription = `Eval√∫a el Ron ${currentRon} seg√∫n los criterios establecidos`;
                
                // Resetear formulario
                document.getElementById('evaluation-form').reset();
                document.getElementById('total-score').textContent = '0';
            } else if (currentStep === 5) {
                document.getElementById('step-5').style.display = 'block';
                stepTitle = 'üèÜ Resumen Final';
                stepDescription = 'Resultados finales de la cata colaborativa';
                generateFinalSummary();
            }

            document.getElementById('step-title').textContent = stepTitle;
            document.getElementById('step-description').textContent = stepDescription;

            // Actualizar botones de navegaci√≥n
            if (isMaster) {
                document.getElementById('prev-btn').disabled = currentStep === 0;
                document.getElementById('next-btn').disabled = currentStep === 5;
            }
        }

        function updateParticipants() {
            const participantsList = document.getElementById('participants-list');
            const participantCount = document.getElementById('participant-count');
            
            const userCount = Object.keys(usersData).length;
            participantCount.textContent = userCount;
            
            participantsList.innerHTML = '';
            
            Object.entries(usersData).forEach(([userId, userData]) => {
                const div = document.createElement('div');
                div.className = 'participant-item';
                
                const name = userData.nombre || 'Sin nombre';
                const evaluationCount = Object.keys(userData.evaluaciones || {}).length;
                const masterIcon = userId === currentUserId ? 'üëë' : '';
                
                div.innerHTML = `
                    <span class="participant-name">${masterIcon} ${name}</span>
                    <span class="participant-progress">${evaluationCount}/4 rones</span>
                `;
                
                participantsList.appendChild(div);
            });
        }

        function updateResults() {
            const resultsContainer = document.getElementById('current-results');
            
            if (currentStep === 0) {
                resultsContainer.innerHTML = '<p>Los resultados aparecer√°n cuando comience la evaluaci√≥n</p>';
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            // Mostrar resultados del ron actual
            if (currentStep >= 1 && currentStep <= 4) {
                const ronActual = RONES[currentStep - 1];
                const resultDiv = document.createElement('div');
                resultDiv.className = 'ron-results';
                resultDiv.innerHTML = `<h4>Ron ${ronActual}</h4>`;
                
                const evaluaciones = [];
                Object.entries(usersData).forEach(([userId, userData]) => {
                    if (userData.evaluaciones && userData.evaluaciones[ronActual]) {
                        evaluaciones.push({
                            nombre: userData.nombre,
                            ...userData.evaluaciones[ronActual]
                        });
                    }
                });
                
                if (evaluaciones.length > 0) {
                    evaluaciones.sort((a, b) => b.total - a.total);
                    
                    evaluaciones.forEach((eval, index) => {
                        const evalDiv = document.createElement('div');
                        evalDiv.className = 'evaluation-item';
                        evalDiv.innerHTML = `
                            <span class="rank">#${index + 1}</span>
                            <span class="evaluator-name">${eval.nombre}</span>
                            <span class="total-score">${eval.total} pts</span>
                        `;
                        resultDiv.appendChild(evalDiv);
                    });
                } else {
                    resultDiv.innerHTML += '<p>No hay evaluaciones a√∫n</p>';
                }
                
                resultsContainer.appendChild(resultDiv);
            }
        }

        function generateFinalSummary() {
            const summaryContainer = document.getElementById('final-rankings');
            summaryContainer.innerHTML = '';
            
            // Calcular rankings por ron
            RONES.forEach(ron => {
                const ronDiv = document.createElement('div');
                ronDiv.className = 'ron-summary';
                ronDiv.innerHTML = `<h4>ü•É Ron ${ron}</h4>`;
                
                const evaluaciones = [];
                Object.entries(usersData).forEach(([userId, userData]) => {
                    if (userData.evaluaciones && userData.evaluaciones[ron]) {
                        evaluaciones.push({
                            nombre: userData.nombre,
                            ...userData.evaluaciones[ron]
                        });
                    }
                });
                
                if (evaluaciones.length > 0) {
                    evaluaciones.sort((a, b) => b.total - a.total);
                    
                    evaluaciones.forEach((eval, index) => {
                        const evalDiv = document.createElement('div');
                        evalDiv.className = 'final-evaluation-item';
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                        evalDiv.innerHTML = `
                            <span class="medal">${medal}</span>
                            <span class="evaluator-name">${eval.nombre}</span>
                            <span class="total-score">${eval.total} pts</span>
                        `;
                        ronDiv.appendChild(evalDiv);
                    });
                    
                    // Promedio
                    const promedio = (evaluaciones.reduce((sum, eval) => sum + eval.total, 0) / evaluaciones.length).toFixed(1);
                    const avgDiv = document.createElement('div');
                    avgDiv.className = 'average-score';
                    avgDiv.innerHTML = `<strong>Promedio: ${promedio} pts</strong>`;
                    ronDiv.appendChild(avgDiv);
                } else {
                    ronDiv.innerHTML += '<p>Sin evaluaciones</p>';
                }
                
                summaryContainer.appendChild(ronDiv);
            });
        }
    </script>
</body>
</html> 